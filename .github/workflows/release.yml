name: Build and Release

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force a release (ignores commit message check)'
        required: false
        type: boolean
        default: false

jobs:
  check-release:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if commit message contains !release
        id: check
        run: |
          # Check if manually triggered with force_release
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && [[ "${{ github.event.inputs.force_release }}" == "true" ]]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "Manual release triggered"
          elif [[ "${{ github.event.head_commit.message }}" == *"!release"* ]]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "Release triggered by commit message"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "No release triggered"
          fi

      - name: Get version from pyproject.toml
        id: get_version
        run: |
          VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

  build-linux:
    needs: check-release
    if: needs.check-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse libfuse2 wget

      - name: Build AppImage
        run: |
          cd packaging
          chmod +x build-appimage.sh
          ./build-appimage.sh

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: BLine-Linux-AppImage
          path: BLine-x86_64.AppImage
          if-no-files-found: error

  build-windows:
    needs: check-release
    if: needs.check-release.outputs.should_release == 'true'
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pillow

      - name: Build Windows executable
        run: |
          cd packaging
          .\build-windows.ps1

      - name: Create portable ZIP
        run: |
          cd packaging
          .\create-portable.ps1

      - name: Install Inno Setup
        run: |
          choco install innosetup -y

      - name: Create installer
        run: |
          cd packaging
          .\create-installer.ps1

      - name: ZIP the executable folder
        run: |
          cd packaging\dist
          Compress-Archive -Path BLine -DestinationPath ..\..\BLine-${{ needs.check-release.outputs.version }}-Windows-Executable.zip

      - name: Upload Windows portable ZIP
        uses: actions/upload-artifact@v4
        with:
          name: BLine-Windows-Portable
          path: BLine-*-Windows-Portable.zip
          if-no-files-found: error

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: BLine-Windows-Installer
          path: packaging/BLine-*-Setup.exe
          if-no-files-found: error

      - name: Upload Windows executable ZIP
        uses: actions/upload-artifact@v4
        with:
          name: BLine-Windows-Executable
          path: BLine-*-Windows-Executable.zip
          if-no-files-found: error

  create-release:
    needs: [check-release, build-linux, build-windows]
    if: needs.check-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: BLine-Linux-AppImage
          path: ./artifacts

      - name: Download Windows portable ZIP
        uses: actions/download-artifact@v4
        with:
          name: BLine-Windows-Portable
          path: ./artifacts

      - name: Download Windows installer
        uses: actions/download-artifact@v4
        with:
          name: BLine-Windows-Installer
          path: ./artifacts

      - name: Download Windows executable ZIP
        uses: actions/download-artifact@v4
        with:
          name: BLine-Windows-Executable
          path: ./artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-release.outputs.version }}
          name: BLine v${{ needs.check-release.outputs.version }}
          body: |
            ## BLine v${{ needs.check-release.outputs.version }}

            ### Downloads

            **Linux:**
            - `BLine-x86_64.AppImage` - Single portable file

            **Windows:**
            - `BLine-${{ needs.check-release.outputs.version }}-Setup.exe` - Installer (recommended)
            - `BLine-${{ needs.check-release.outputs.version }}-Windows-Portable.zip` - Portable ZIP (no install)
            - `BLine-${{ needs.check-release.outputs.version }}-Windows-Executable.zip` - Executable folder

            ### Installation

            **Linux:**
            1. Download `BLine-x86_64.AppImage`
            2. Make it executable: `chmod +x BLine-x86_64.AppImage`
            3. Run: `./BLine-x86_64.AppImage`

            **Windows (Installer):**
            1. Download and run `BLine-${{ needs.check-release.outputs.version }}-Setup.exe`
            2. Follow the installation wizard
            3. Launch from Start Menu

            **Windows (Portable):**
            1. Download and extract the portable ZIP
            2. Run `BLine.exe`
            3. No installation required!

            ---
            *Built automatically by GitHub Actions*
          files: |
            artifacts/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
